<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TUVN - Monitoreo de Temperatura</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<style>body { font-family: 'Roboto', sans-serif; }</style>
</head>
<body class="bg-slate-900 text-slate-200 min-h-screen flex flex-col">

<header class="bg-slate-800 text-white shadow-lg border-b-4 border-red-600">
  <div class="container mx-auto px-4 py-4 flex justify-between items-center">
    <div>
      <h1 class="text-2xl font-bold">TUVN - Monitoreo Térmico</h1>
      <p class="text-sm text-slate-300">Integrantes: <span class="font-bold">Axel Allaica y Edwin Guale</span></p>
    </div>
    <div class="flex items-center gap-3">
      <div class="relative flex h-3 w-3">
        <span id="pingDot" class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-300 opacity-75 hidden"></span>
        <span id="staticDot" class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>
      </div>
      <span id="statusText" class="text-sm font-mono text-red-300">Desconectado</span>
    </div>
  </div>
</header>

<main class="flex-grow container mx-auto px-4 py-10">
  <h2 class="text-3xl font-bold mb-8 text-center text-white">Temperaturas de Sensores</h2>

  <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-10">

    <div class="bg-slate-800 rounded-xl border border-slate-700 shadow-xl p-6 text-center">
      <h3 class="text-red-400 font-bold mb-2">SENSOR 1</h3>
      <div id="s1" class="text-4xl font-bold text-white">--</div>
      <p class="text-slate-400 mt-2 text-sm">°C</p>
    </div>

    <div class="bg-slate-800 rounded-xl border border-slate-700 shadow-xl p-6 text-center">
      <h3 class="text-blue-400 font-bold mb-2">SENSOR 2</h3>
      <div id="s2" class="text-4xl font-bold text-white">--</div>
      <p class="text-slate-400 mt-2 text-sm">°C</p>
    </div>

    <div class="bg-slate-800 rounded-xl border border-slate-700 shadow-xl p-6 text-center">
      <h3 class="text-red-400 font-bold mb-2">SENSOR 3</h3>
      <div id="s3" class="text-4xl font-bold text-white">--</div>
      <p class="text-slate-400 mt-2 text-sm">°C</p>
    </div>

    <div class="bg-slate-800 rounded-xl border border-slate-700 shadow-xl p-6 text-center">
      <h3 class="text-blue-400 font-bold mb-2">SENSOR 4</h3>
      <div id="s4" class="text-4xl font-bold text-white">--</div>
      <p class="text-slate-400 mt-2 text-sm">°C</p>
    </div>

    <div class="bg-slate-800 rounded-xl border border-slate-700 shadow-xl p-6 text-center">
      <h3 class="text-emerald-400 font-bold mb-2">PROMEDIO</h3>
      <div id="promedio" class="text-4xl font-bold text-white">--</div>
      <p class="text-slate-400 mt-2 text-sm">°C</p>
    </div>
  </div>

  <!-- GRÁFICA DE PROMEDIO -->
  <div class="bg-slate-800 rounded-xl border border-slate-700 shadow-xl p-6 mb-10">
    <canvas id="tempChart" height="150"></canvas>
  </div>

  <div class="flex justify-center">
    <button id="connectBtn" onclick="toggleConnection()"
      class="bg-red-700 hover:bg-red-600 text-white font-bold py-4 px-10 rounded-full shadow-lg flex items-center gap-3 transition-transform hover:scale-105 active:scale-95">
      <i data-lucide="bluetooth" class="w-6 h-6"></i>
      <span>CONECTAR DISPOSITIVO</span>
    </button>
  </div>
</main>

<footer class="bg-slate-900 text-slate-500 py-6 text-center text-xs border-t-4 border-red-600">
<p>©️ 2025 Instituto Superior Tecnológico Vida Nueva</p>
</footer>

<script>
lucide.createIcons();

const serviceUuid = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
const characteristicUuid = "beb5483e-36e1-4688-b7f5-ea07361b26a8";

let bluetoothDevice, bleCharacteristic;
const connectBtn = document.getElementById('connectBtn');
const statusText = document.getElementById('statusText');
const pingDot = document.getElementById('pingDot');
const staticDot = document.getElementById('staticDot');

const s1 = document.getElementById('s1');
const s2 = document.getElementById('s2');
const s3 = document.getElementById('s3');
const s4 = document.getElementById('s4');
const promedioEl = document.getElementById('promedio');

let chartData = {labels:[], datasets:[{label:'Temp Promedio', data:[], borderColor:'lime', backgroundColor:'rgba(0,255,0,0.2)', fill:true}]};
let ctx = document.getElementById('tempChart').getContext('2d');
let tempChart = new Chart(ctx, {type:'line', data:chartData, options:{responsive:true, animation:false, scales:{y:{min:0, max:50}}}});

async function toggleConnection(){bluetoothDevice && bluetoothDevice.gatt.connected?disconnect():connect();}
async function connect(){
  try{
    connectBtn.innerHTML='<span class="animate-spin">⌛</span> BUSCANDO...';
    bluetoothDevice = await navigator.bluetooth.requestDevice({filters:[{name:'TUVN_Termometros'}], optionalServices:[serviceUuid]});
    bluetoothDevice.addEventListener('gattserverdisconnected', onDisconnected);
    const server = await bluetoothDevice.gatt.connect();
    const service = await server.getPrimaryService(serviceUuid);
    bleCharacteristic = await service.getCharacteristic(characteristicUuid);
    await bleCharacteristic.startNotifications();
    bleCharacteristic.addEventListener('characteristicvaluechanged', handleData);
    updateUIConnected();
  }catch{updateUIDisconnected();}
}
function disconnect(){bluetoothDevice.gatt.connected && bluetoothDevice.gatt.disconnect();}
function onDisconnected(){updateUIDisconnected();}

function handleData(event){
  const json = JSON.parse(new TextDecoder().decode(event.target.value));
  if(json.s1!==undefined) s1.innerText=json.s1.toFixed(1);
  if(json.s2!==undefined) s2.innerText=json.s2.toFixed(1);
  if(json.s3!==undefined) s3.innerText=json.s3.toFixed(1);
  if(json.s4!==undefined) s4.innerText=json.s4.toFixed(1);
  if(json.prom!==undefined){
    promedioEl.innerText=json.prom.toFixed(1);
    // actualizar gráfica
    const now = new Date().toLocaleTimeString();
    chartData.labels.push(now);
    chartData.datasets[0].data.push(json.prom.toFixed(1));
    if(chartData.labels.length>20){chartData.labels.shift(); chartData.datasets[0].data.shift();}
    tempChart.update();
  }
  pingDot.classList.remove('hidden');
  setTimeout(()=>pingDot.classList.add('hidden'),300);
}

function updateUIConnected(){
  connectBtn.innerHTML='DESCONECTAR'; connectBtn.classList.replace('bg-red-700','bg-emerald-700');
  statusText.innerText="CONECTADO"; statusText.classList.replace('text-red-300','text-emerald-300');
  staticDot.classList.replace('bg-red-500','bg-emerald-400');
}

function updateUIDisconnected(){
  connectBtn.innerHTML='<i data-lucide="bluetooth" class="w-6 h-6"></i> CONECTAR DISPOSITIVO'; lucide.createIcons();
  connectBtn.classList.replace('bg-emerald-700','bg-red-700');
  statusText.innerText="DESCONECTADO"; statusText.classList.replace('text-emerald-300','text-red-300');
  staticDot.classList.replace('bg-emerald-400','bg-red-500');
  s1.innerText=s2.innerText=s3.innerText=s4.innerText=promedioEl.innerText="--";
}
</script>

</body>
</html>
